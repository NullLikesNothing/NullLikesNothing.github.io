<!DOCTYPE html>
<html>
  <head>
    <title>Offline chat</title>
    <style>
      body {
        background-color: #000;
        color: #fff;
        width: 100vw;
        height: 100vh;
      }
      #msgs {
        display: block;
        background-color: #444;
        color: #fff;
        width: 90%;
        height: 90%;
      }
    </style>
  </head>
  <body>
    <input id="name" placeholder="Name"><input disabled id="msg" placeholder="Message"><button id="clear">Clear messages</button>
    <br>
    <div id="msgs"><i>No messages...</i></div>
    <script defer>
      const messages = document.querySelector('#msgs')
      const msgInp = document.querySelector('#msg')
      const nameInp = document.querySelector('#name')
      let cap = {
        msg: 'MSG',
        dc: 'DC',
        reg: 'REG',
        clr: 'CLR',
        regerr: 'REGERR',
        ref: 'REF',
        nop: 'NOP',
      }
      const server = new SharedWorker("shw.js", "Server")
      var sv = server.port
      
      window.onunload = () => {
        sv.postMessage([cap.dc])
      }
      
      sv.onmessage = e => {
        let data = e.data
        if (data[0] === cap.regerr) {
          nameInp.value = ''
          nameInp.disabled = false
          msgInp.disabled = true
          msgInp.value = ''
          nameInp.focus()
        } else if (data[0] === cap.msg) {
          messages.innerText = ''
          data[1].forEach(msg => {
            messages.innerText += msg + "\n"
          });
        } else if (data[0] === cap.ref) {
          location.reload();
        } else if (data[0] === cap.nop) {
          console.log(`${data[1]}`)
        } else {
          console.warn(`Got unknown command "${data[0]}".`,data)
        }
      }
      let tmp_name = (new URLSearchParams(window.location.search)).get('name')
      if (tmp_name != null) {
        tmp_name = tmp_name.trim()
        if (tmp_name !== "") {
          sv.postMessage([cap.reg,tmp_name])
          nameInp.disabled = true
          nameInp.value = tmp_name
          msgInp.disabled = false
          msgInp.focus()
        }
      }
      nameInp.onkeydown = e => {
        if (e.key !== 'Enter') return
        if (nameInp.value.trim() === "") {
          nameInp.value = '';
          return alert("Name cannot be blank or whitespace!")
        }
        sv.postMessage([cap.reg, nameInp.value.trim()])
        nameInp.disabled = true
        msgInp.value = ''
        msgInp.disabled = false
        msgInp.focus()
      }
      msgInp.onkeydown = e => {
        if (e.key !== 'Enter') return
        sv.postMessage([cap.msg, msgInp.value])
        msgInp.value = '';
        msgInp.focus()
      }
      document.querySelector('#clear').onclick = () => {
        sv.postMessage([cap.clr])
      }
    </script>
  </body>
</html>
